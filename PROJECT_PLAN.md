# RX65N Virtual Execution Environment Project Plan

本計画書は、以下の「学習内容」および「基本設計書」をWebブラウザ上で完全再現するための開発計画である。
以下の**第1章は、提示された要件・設計文面を一言一句変更せずに記載したものである。** 開発はこの内容を絶対遵守して行われる。

---

## 1. 要件定義・基本設計書 (原文)

### 学習内容
*   **マイコンの基本構成と動作原理**
    *   ○マイコンの基本構成
    *   ○マイコンの動作
    *   ○マイコンの種類と応用分野
    *   ○RXの概要
*   **マイコンの制御方法**
    *   ○CPU内部レジスタ
    *   ○命令とプログラム
    *   ○CPUの基本動作と命令
    *   ○C言語との対比
*   **発振回路とリセット**
    *   ○発振回路とリセット
*   **周辺機能**
    *   ○CPUと入出力装置のインタフェース
    *   ○入出力ポート
    *   ○タイマ
*   **割り込み**
    *   ○割り込みの概念
    *   ○割り込みプログラム
    *   ○割り込みの動作
*   **RXファミリ用C/C++コンパイラパッケージ**
*   **RX65Nターゲットボード**

---

### RXマイコン仮想実行環境 基本設計書（要件定義＋構成設計）

#### 1. システムの目的
本システムは、Renesas RXファミリ（RX65N相当）の以下内容を実機を使わず仮想環境で再現・学習・検証できることを目的とする。

**対象範囲：**
*   CPU構造・命令動作
*   C言語とCPU動作の対応
*   クロック・リセット
*   GPIO・タイマ
*   割り込み
*   RX用C/C++コンパイラ出力の実行
*   RX65Nターゲットボード相当のI/O

#### 2. システム全体構成（設計レベル）
```text
[ UI / デバッガ層 ]
│
[ 実行制御・表示管理 ]
│
[ 仮想RX CPUコア ]
│
[ メモリ / レジスタモデル ]
│
[ 周辺機能モデル ] (GPIO / Timer / INT / UART)
│
[ 仮想ボードI/Oモデル ] (LED / SW / Reset)
```

#### 3. 必要な構成要素（設計単位）

**3.1 CPUコアモジュール**
*   **役割**: RX CPUの命令実行・レジスタ管理・PC制御を行う中核モジュール
*   **必要な機能**:
    *   汎用レジスタ（R0〜R15）
    *   PC（プログラムカウンタ）
    *   SP（スタックポインタ）
    *   PSW（ステータスレジスタ）
    *   命令フェッチ／デコード／実行ループ
    *   分岐命令・演算命令・ロード／ストア命令
*   **必要な設計項目**:
    *   命令デコーダ設計
    *   実行関数テーブル
    *   フラグ更新ロジック

**3.2 メモリ／リセットモジュール**
*   **役割**: Flash・RAM・スタック領域を仮想再現
*   **必要な機能**:
    *   Flash（プログラム格納）
    *   RAM（変数・スタック）
    *   メモリマップ管理
    *   リセット時の初期化
*   **必要な設計項目**:
    *   RX65N相当のアドレス割当
    *   ベクタテーブル配置
    *   初期PC／SP設定

**3.3 クロック／実行制御モジュール**
*   **役割**: 発振回路・実行速度・リセット連動を再現
*   **必要な機能**:
    *   内部クロック／外部クロック切替
    *   実行速度設定（実時間／低速モード）
    *   リセット解除タイミング管理
*   **必要な設計項目**:
    *   クロック源設定レジスタ
    *   実行ステップ単位管理

**3.4 周辺機能モジュール**
*   **3.4.1 GPIOモジュール**
    *   **役割**: 入出力ポート制御
    *   **必要な機能**:
        *   方向設定（入力／出力）
        *   出力値の保持
        *   入力値の外部反映
    *   **設計項目**:
        *   PDR（方向レジスタ）
        *   PODR / PIDR 相当設計
*   **3.4.2 タイマモジュール**
    *   **役割**: 周期動作・割り込み生成
    *   **必要な機能**:
        *   カウンタ
        *   比較一致判定
        *   周期割り込み生成
    *   **設計項目**:
        *   TCNT / TCR / TIER 相当
        *   割り込み発行IF

**3.5 割り込み制御モジュール**
*   **役割**: 割り込み受付・優先順位・復帰制御
*   **必要な機能**:
    *   ベクタ参照
    *   割り込み優先度管理
    *   ネスト制御
    *   RETI相当処理
*   **設計項目**:
    *   割り込み要求キュー
    *   PSWのIビット管理
    *   スタック退避処理

**3.6 C/C++コンパイラ連携モジュール**
*   **役割**: RX用コンパイラ出力（ELF/BIN）を実行環境へロード
*   **必要な機能**:
    *   ELF/BINパーサ
    *   シンボル読込み
    *   Flash配置
*   **設計項目**:
    *   セクション配置ロジック
    *   デバッグ用シンボル保持

**3.7 仮想RX65Nターゲットボードモデル**
*   **役割**: 実機ボード相当のI/O表現
*   **必要な機能**:
    *   LED表示
    *   スイッチ入力
    *   UARTログ出力
    *   リセットSW
*   **設計項目**:
    *   UIとの連携IF
    *   入出力イベント伝搬設計

**3.8 UI／デバッグモジュール**
*   **役割**: 内部状態可視化と操作
*   **必要な機能**:
    *   Run / Stop / Step
    *   レジスタ表示
    *   メモリ表示
    *   I/O状態表示
    *   割り込みログ
*   **設計項目**:
    *   表示更新周期
    *   実行制御イベント設計

#### 4. 必要な設計成果物（作るべきもの）
| 種別 | 内容 |
| :--- | :--- |
| **アーキテクチャ図** | モジュール構成・依存関係 |
| **クラス／構造設計** | CPU, Memory, GPIO, Timer, INT |
| **メモリマップ設計書** | アドレス割当表 |
| **命令仕様表** | 実装するRX命令一覧 |
| **割り込み仕様** | ベクタ番号・優先度 |
| **UI画面設計** | レジスタ・I/O表示構成 |
| **実行制御仕様** | Step/Run/Reset動作 |

#### 5. 本設計で実現できる状態
この設計通り構築すれば：
*   RX65N相当のCコードが実行できる
*   GPIO制御がUIで見える
*   タイマ割り込みが再現できる
*   割り込みネスト・復帰が確認できる
*   実機なしで演習が成立する

---

## 2. 実装計画 (Web環境における具現化)

上記「基本設計書」をWebブラウザ上で完結するシステムとして実装するための詳細計画。

### 2.1 技術スタック
*   **Frontend**: React (TypeScript) - コンポーネント指向によるモジュール化。
*   **Editor**: Monaco Editor - 「命令とプログラム」「C言語との対比」を実現するためのコード記述エリア。
*   **Core**: Pure TypeScript - CPU、メモリ、周辺機能のロジックはUIから分離して実装。

### 2.2 開発フェーズ

#### Phase 1: 設計成果物の作成と基盤構築
**目的**: 「4. 必要な設計成果物」のうち基盤に関わるものを作成し、プロジェクトの土台を作る。
1.  **環境構築**: Vite + React + TypeScript プロジェクト作成。
2.  **アーキテクチャ図・クラス設計**: `src/core` 以下のディレクトリ構造とインターフェース定義 (`ICpu`, `IMemory`, `IPeripheral`)。
3.  **メモリマップ設計**: RX65Nの仕様に基づき `Memory` クラスにアドレス定数を定義。
4.  **CPUコア基盤**: `CpuCore` クラスの作成 (R0-R15, PC, SP, PSWの実装)。

#### Phase 2: CPU命令実行とコンパイラ連携
**目的**: 「3.1 CPUコアモジュール」および「3.6 C/C++コンパイラ連携モジュール」の実装。
1.  **命令セット実装**: 基本命令 (MOV, ADD, CMP, BRA等) のデコードと実行ロジック。
2.  **ELF/BINパーサ**: Web File APIを使用し、コンパイル済みバイナリファイルを読み込んで `Memory` に配置する機能。
3.  **簡易アセンブラ/コンパイラ**: Web上でコードを書き、その場でメモリに展開する機能（「Webで完結」要件への対応）。

#### Phase 3: 周辺機能とターゲットボード
**目的**: 「3.4 周辺機能モジュール」「3.7 仮想ターゲットボードモデル」の実装。
1.  **GPIO**: `Gpio` クラス (PDR, PODR, PIDR) と、UI上のLED/スイッチコンポーネントの双方向バインディング。
2.  **UART**: コンソール出力用のバッファとUI表示。
3.  **Clock**: `Clock` クラス (SCKCR) 実装。実行速度の可変制御UI。

#### Phase 4: 割り込みとタイマ
**目的**: 「3.5 割り込み制御モジュール」「3.4.2 タイマモジュール」の実装。
1.  **Timer**: カウントアップロジックとコンペアマッチ検出。
2.  **ICU**: 割り込みコントローラの実装。優先度判定とCPUへの通知、ベクタテーブル参照。
3.  **ネスト制御**: PSW.Iビットとスタック退避・復帰 (RTE命令) の検証。

#### Phase 5: 統合と検証
**目的**: 「5. 本設計で実現できる状態」の確認。
1.  **全体結合**: 各モジュールの連携確認。
2.  **サンプル実行**: Lチカ、タイマ割り込み等のサンプルプログラムが動作することを確認。
3.  **UI仕上げ**: RX65Nボードを模した直感的なデザインへの調整。